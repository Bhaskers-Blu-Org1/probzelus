open Cart_pole
open Pendulum

let node cart_pole_gym render action = obs, reward, stop where
  rec init instance_id = cart_init ()
  and init r = 0.
  and automaton
      | Reset -> local dummy
          do obs, reward, stop = cart_reset instance_id, 1., false
          and dummy = print_endline ("Episode reward: "^(string_of_float (last r)))
          and r = 0.
          then Run
      | Run ->
          do obs, reward, stop = cart_step instance_id action render
          and r = reward +. last r
          until stop then Reset

let node controller (pstate, obs) = action where
  rec action =
    if Infer.sample (pstate, Distribution.bernoulli 0.5) then Right else Left

let node model (pstate, obs_gym) = action where
  rec obs = simple_pendulum (obs_gym, (Right fby action))
  and action = controller (pstate, obs)
  and () = Infer.factor (pstate, -10. *. (abs_float (obs.pole_angle)))
  and display = draw_obs_back obs

let node smart_main () = () where
  rec reset action = Infer.plan 10 10 model obs
      every true
  and obs, _, stop = cart_pole_gym true (Right fby action)
  and display = draw_obs_front obs
